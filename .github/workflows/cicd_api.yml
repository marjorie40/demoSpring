name: cicd_api.yml
run-name: ${{ github.actor }} GitHub Actions Workflow CICD API
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write  #suggere par IA car bug pour acces avec allure report

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      # Service MySQL pour tests d'intÃ©gration
      mysql:
        image: mysql:8
        env:
          MYSQL_DATABASE: ${{ secrets.DB_NAME }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD}}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # test d'attente de mise en service du conteneur MySQL ping pointe vers lui meme peut mettre le nom conteneur mysql
      - name: wait_for_MySQL_to_be_ready
        run: |
          while ! mysqladmin ping -h"127.0.0.1" -P"3306" --silent; do  
          sleep 1
          done
      # 1. Checkout du code recopie du depot dans executeur
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      # 2. Setup JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: temurin

      - name: Create_Database_from_script
        run: mysql -h 127.0.0.1 -u root -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} < infra/mysql/script.sql

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=marjorie40_demoSpring #verify important
      #
      - name: Deploy_Allure_Report_to_GitHub_Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.PERSONAL_TOKEN_ALLURE }}
          publish_dir: target/site/allure-maven-plugin  #emplacement faire mvn site pour push retrait du :target/  ?
          destination_dir: allure-report
          keep_files: false

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: my-app-jar  #name important pour la seconde phase Docker automatisation
          path: target/*.jar
          retention-days: 1

  # notifications sur canal Teams DEVOPS notifications-test
  Team_Notification:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: MS Teams Deploy Card
        uses: dchourasia/ms-teams-notification@1.0 #or "./" dans un set-up local
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}

  docker-build-image-api:
    # verifie que le declenchement provient de la branche main
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: build #pas de titre au dessus de name ...
    steps:
      - uses: actions/checkout@v3
      - name: Set Up QEMU  # option si besoin de plusieurs plateforme : mac, windows, linux
        uses: docker/setup-qemu-action@v3
      - name: Set Up Docker Build # option si besoin de ARM64 , AMD64
        uses: docker/setup-buildx-action@v3
      - name: Connect to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Download a single artifact
        uses: actions/download-artifact@v4
        with:
          name: my-app-jar

#        # optionnel : juste pour controle
#        - name: List files in the repository
#        run: ls ${{ github.workspace }}

      # construction de l'image docker et push sur dockerHub
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USER }}/apispringboot2026:latest

      # message de fin indiquant que tout s'est bien passe
      - run: echo "this job status is ${{ job.status }}."
